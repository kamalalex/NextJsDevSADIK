generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  email           String    @unique
  password        String
  name            String
  avatar          String?
  role            UserRole
  phone           String?
  isActive        Boolean   @default(true)
  companyId       String?   @db.ObjectId
  company         Company?  @relation(fields: [companyId], references: [id])
  createdOperations Operation[] @relation("CreatedOperations")
  uploadedDocuments Document[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  driver          Driver?
  invoiceHistory  InvoiceHistory[]
  @@map("users")
}

model Company {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  name            String    @unique
  type            CompanyType
  address         String?
  phone           String?
  email           String?
  logo            String?
  ice             String?
  contactPerson   String?
  contactPhone    String?
  contactEmail    String?
  sadicCode       String?
  linkedClientIds String[]  @db.ObjectId
  isActive        Boolean   @default(true)
  trialEndsAt     DateTime?
  subscriptionStatus SubscriptionStatus @default(TRIAL)
  maxUsers        Int       @default(5)
  users           User[]
  vehicles        Vehicle[]
  drivers         Driver[]
  clientOperations Operation[] @relation("ClientOperations")
  transportOperations Operation[] @relation("TransportOperations")
  clientInvoices  Invoice[] @relation("ClientInvoices")
  transportInvoices Invoice[] @relation("TransportInvoices")
  subcontractorPayments SubcontractorPayment[] @relation("SubcontractorPayments")
  subcontractors  Subcontractor[]
  servedSubcontractors Subcontractor[] @relation("LinkedCompanySubcontractor")
  createdAt       DateTime  @default(now())
  @@map("companies")
}

model Operation {
  id                  String    @id @default(auto()) @map("_id") @db.ObjectId
  reference           String    @unique
  operationDate       DateTime
  status              OperationStatus @default(PENDING)
  priority            Priority  @default(MEDIUM)
  loadingPoints       Json[]
  unloadingPoints     Json[]
  vehicleType         VehicleType
  ptac                PtacType
  totalWeight         Float
  packaging           PackagingType?
  quantity            Int?
  licensePlate        String?
  salePrice           Float?
  purchasePrice       Float?
  subcontractedByCompany Boolean @default(false)
  subcontractedBySubcontractor Boolean @default(false)
  subcontractorId     String?   @db.ObjectId
  subcontractor       Subcontractor? @relation(fields: [subcontractorId], references: [id])
  paymentStatus       PaymentStatus @default(PENDING)
  invoiceId           String?   @db.ObjectId
  invoice             Invoice?  @relation(fields: [invoiceId], references: [id])
  subcontractorPaid   Boolean   @default(false)
  subcontractorPaidAt DateTime?
  subcontractorPaymentId String? @db.ObjectId
  subcontractorPayment SubcontractorPayment? @relation(fields: [subcontractorPaymentId], references: [id])
  createdById         String    @db.ObjectId
  createdBy           User      @relation("CreatedOperations", fields: [createdById], references: [id])
  assignedDriverId    String?   @db.ObjectId
  assignedDriver      Driver?   @relation(fields: [assignedDriverId], references: [id])
  assignedVehicleId   String?   @db.ObjectId  
  assignedVehicle     Vehicle?  @relation(fields: [assignedVehicleId], references: [id])
  clientId            String?   @db.ObjectId
  client              Company?  @relation("ClientOperations", fields: [clientId], references: [id])
  transportCompanyId  String?   @db.ObjectId
  transportCompany    Company?  @relation("TransportOperations", fields: [transportCompanyId], references: [id])
  trackingUpdates     TrackingUpdate[]
  documents           Document[]
  assignedDrivers     DriverAssignment[]
  currentLocation     Json?
  sealNumber          String?
  observations        String?
  cancellationReason  String?
  estimatedDuration   Int?
  distance            Float?
  actualDuration      Int?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  confirmedAt         DateTime?
  startedAt           DateTime?
  deliveredAt         DateTime?
  @@map("operations")
  @@index([status])
  @@index([clientId, transportCompanyId])
  @@index([operationDate])
}

model DriverAssignment {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  operationId   String   @db.ObjectId
  operation     Operation @relation(fields: [operationId], references: [id], onDelete: Cascade)
  driverId      String   @db.ObjectId
  driver        Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  assignedPrice Float
  vehiclePlate  String?
  status        DriverAssignmentStatus @default(EN_ATTENTE)
  createdAt DateTime @default(now())
  @@unique([operationId, driverId])
  @@map("driver_assignments")
}

model TrackingUpdate {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  operationId String   @db.ObjectId
  operation   Operation @relation(fields: [operationId], references: [id], onDelete: Cascade)
  status      OperationStatus
  location    Json?
  note        String?
  photos      String[]
  recordedBy  String
  createdAt DateTime @default(now())
  @@map("tracking_updates")
}

model Document {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  operationId String   @db.ObjectId
  operation   Operation @relation(fields: [operationId], references: [id], onDelete: Cascade)
  type        DocumentType
  url         String
  filename    String
  uploadedById String   @db.ObjectId
  uploadedBy  User     @relation(fields: [uploadedById], references: [id])
  createdAt DateTime @default(now())
  @@map("documents")
}

model Vehicle {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  plateNumber String   @unique
  model       String
  capacity    String
  vehicleType VehicleType
  status      VehicleStatus @default(ACTIVE)
  brand                   String?
  firstCirculationDate    DateTime?
  technicalInspectionDate DateTime?
  insuranceDate           DateTime?
  length          Float?
  width           Float?
  height          Float?
  documents       String[]
  registrationFront String?
  registrationBack  String?
  vehiclePhoto      String?
  ptac            PtacType?
  companyId       String?        @db.ObjectId
  company         Company?       @relation(fields: [companyId], references: [id])
  subcontractorId String?        @db.ObjectId
  subcontractor   Subcontractor? @relation(fields: [subcontractorId], references: [id])
  driverId    String?  @db.ObjectId
  driver      Driver?  @relation(fields: [driverId], references: [id])
  operations  Operation[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@map("vehicles")
}

model Driver {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  email       String?
  phone       String
  license     String
  licenseCategory LicenseCategory?
  status      DriverStatus @default(ACTIVE)
  cin         String?
  sadicCode   String?
  licenseDate DateTime?
  documents   String[]
  companyId       String?        @db.ObjectId
  company         Company?       @relation(fields: [companyId], references: [id])
  subcontractorId String?        @db.ObjectId
  subcontractor   Subcontractor? @relation(fields: [subcontractorId], references: [id])
  isIndependent Boolean @default(false)
  professionalCard String?
  idCardFront    String?
  idCardBack     String?
  licenseFront   String?
  licenseBack    String?
  userId          String?   @unique @db.ObjectId
  user            User?     @relation(fields: [userId], references: [id])
  assignments DriverAssignment[]
  vehicles    Vehicle[]
  operations  Operation[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@map("drivers")
}

model Subcontractor {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  companyName String
  phone       String
  email       String?
  address     String?
  companyId   String?
  sadicCode   String?
  paymentWithInvoice Boolean @default(true)
  vehicles    Vehicle[]
  operations  Operation[]
  drivers     Driver[]
  payments    SubcontractorPayment[]
  transportCompanyId String   @db.ObjectId
  transportCompany   Company  @relation(fields: [transportCompanyId], references: [id])
  linkedCompanyId    String?  @db.ObjectId
  linkedCompany      Company? @relation("LinkedCompanySubcontractor", fields: [linkedCompanyId], references: [id])
  status             PartnerStatus @default(ACTIVE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@map("subcontractors")
}

model Invoice {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  number      String   @unique
  date        DateTime
  subtotal    Float    @default(0)
  taxAmount   Float    @default(0)
  totalAmount Float    @default(0)
  
  status      InvoiceStatus @default(DRAFT)
  paymentStatus PaymentStatus @default(PENDING)
  dueDate     DateTime      @default(now()) // Added back
  
  // Partial Payments configuration
  partialPaymentsAllowed Boolean @default(false)
  minPaymentPercentage  Float?
  maxInstallments       Int?
  
  // Relations
  items        InvoiceLine[]
  installments PaymentInstallment[]
  history      InvoiceHistory[]
  
  notes       String?
  terms       String?
  documentUrl String?
  
  operations  Operation[]
  clientId    String   @db.ObjectId
  client      Company  @relation("ClientInvoices", fields: [clientId], references: [id])
  transportCompanyId String   @db.ObjectId
  transportCompany   Company  @relation("TransportInvoices", fields: [transportCompanyId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@map("invoices")
}

model InvoiceLine {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  invoiceId   String   @db.ObjectId
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  quantity    Float    @default(1)
  unitPrice   Float
  vatRate     Float    // e.g., 20, 12, etc.
  taxAmount   Float    // total tax for this line
  totalLine   Float    // quantity * unitPrice + taxAmount
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@map("invoice_lines")
}

model PaymentInstallment {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  invoiceId   String   @db.ObjectId
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  amount      Float
  dueDate     DateTime
  paidAt      DateTime?
  status      PaymentStatus @default(PENDING)
  transactionRef String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@map("payment_installments")
}

model InvoiceHistory {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  invoiceId   String   @db.ObjectId
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  statusFrom  InvoiceStatus?
  statusTo    InvoiceStatus
  action      String?   // Description of the action
  userId      String    @db.ObjectId
  user        User      @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())
  @@map("invoice_history")
}

model SubcontractorPayment {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  paymentNumber String @unique
  paymentDate DateTime
  totalAmount Float
  status      PaymentStatus @default(PENDING)
  documentUrl String?
  notes       String?
  subcontractorId String        @db.ObjectId
  subcontractor   Subcontractor @relation(fields: [subcontractorId], references: [id])
  transportCompanyId String   @db.ObjectId
  transportCompany   Company  @relation("SubcontractorPayments", fields: [transportCompanyId], references: [id])
  operations Operation[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@map("subcontractor_payments")
}

enum UserRole {
  SUPER_ADMIN
  SUPER_ASSISTANT
  SUPER_COMMERCIAL
  SUPER_FINANCE
  COMPANY_ADMIN
  COMPANY_OPERATOR
  CLIENT_ADMIN
  CLIENT_LOGISTICS
  INDEPENDENT_DRIVER
  EMPLOYED_DRIVER
}

enum CompanyType {
  TRANSPORT_COMPANY
  CLIENT_COMPANY
}

enum OperationStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  DELIVERED
  CANCELLED
}

enum VehicleType {
  RIDEL
  FOURGON
  BACHE
  PLATEAU
  PORTE_CONTENEUR
  BENNE
  FRIGO
  AUTRE
}

enum PtacType {
  PTAC_LESS_3_5T
  PTAC_3_5T
  PTAC_7T
  PTAC_14T
  PTAC_19T
  PTAC_25T
  PTAC_MORE_25T
}

enum PackagingType {
  PALLET
  PARCEL
  BULK
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
  PARTIALLY_PAID
}

enum Priority {
  LOW
  MEDIUM 
  HIGH
  URGENT
}

enum DriverAssignmentStatus {
  EN_ATTENTE
  CONFIRME
  EN_COURS
  TERMINE
  ANNULE
}

enum DocumentType {
  BON_LIVRAISON
  BON_COMMANDE
  PHOTO_CHARGEMENT
  PHOTO_DECHARGEMENT
  FACTURE
  SCELES
  TRACKING_PDF
  CARTE_GRISE
  ASSURANCE
  VISITE_TECHNIQUE
  PERMIS_CONDUIRE
  CIN
  AUTRE
}

enum VehicleStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

enum DriverStatus {
  ACTIVE
  INACTIVE
  ON_MISSION
}

enum InvoiceStatus {
  DRAFT
  APPROVED
  SENT
  PARTIALLY_PAID
  PAID
  OVERDUE
  REMINDER
  DISPUTE
  CANCELLED
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  SUSPENDED
  EXPIRED
}

enum LicenseCategory {
  A
  B
  C
  D
  EB
  EC
  ED
}

enum PartnerStatus {
  PENDING
  ACTIVE
  REJECTED
}
